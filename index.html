<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CALCULADORA PCL-SOAT</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111111" />

  <link rel="icon" href="icon.png" />
  <link rel="stylesheet" href="assets/css/styles.min.css" />

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self';
                 connect-src 'self';
                 object-src 'none';
                 base-uri 'self';
                 frame-ancestors 'none'">
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <img class="brand__icon" src="icon.png" alt="PCL-SOAT" onerror="this.style.display='none'">
      <div>
        <div class="brand__title">CALCULADORA PCL-SOAT</div>
        <div class="brand__subtitle">Motor de liquidación (SMLDV) — Offline-first</div>
      </div>
    </div>
    <div class="status">
      <span id="netStatus" class="pill">Online</span>
      <span id="swStatus" class="pill pill--muted">SW: —</span>
    </div>
  </header>

  <main class="wrap">
    <!-- ====== PREMIUM ACTIVATION PANEL (Signed License) ====== -->
    <section id="premiumPanel" class="card">
      <div class="row row--spread row--wrap">
        <div>
          <div class="h">Activación Premium</div>
          <div id="premiumStatus" class="muted">Estado: <b>FREE</b></div>
          <div id="premiumUser" class="muted" style="display:none;"></div>
          <div id="premiumDays" class="muted" style="display:none;"></div>
        </div>

        <div class="btnrow">
          <button id="btnOpenLicense" class="btn">Activar / Gestionar</button>
          <button id="btnClearLicense" class="btn btn--ghost">Quitar licencia</button>
        </div>
      </div>

      <div id="licenseModal" class="modal" aria-hidden="true">
        <div class="modal__card">
          <div class="row row--spread">
            <div class="h">Licencia Premium</div>
            <button id="btnCloseLicense" class="btn btn--ghost">Cerrar</button>
          </div>

          <label class="lbl">Pegar token</label>
          <textarea id="licenseToken" class="mono" placeholder="Pega aquí el token firmado (payload.firma)"></textarea>

          <div class="btnrow">
            <button id="btnValidateLicense" class="btn">Validar licencia</button>
            <button id="btnCopyState" class="btn btn--ghost">Copiar estado</button>
          </div>

          <div id="licenseMsg" class="msg" role="status" aria-live="polite"></div>
          <div class="muted small">
            Nota: el token se guarda localmente (localStorage). Sin backend.
          </div>
        </div>
      </div>
    </section>

    <!-- ====== CALCULATOR ====== -->
    <section class="card">
      <div class="h">Cálculo PCL (Incapacidad Permanente – SOAT)</div>

      <div class="grid">
        <div>
          <label class="lbl">Año (SMMLV)</label>
          <select id="year">
            <option value="2026">2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
          </select>
          <div class="muted small" id="smmlvInfo"></div>
        </div>

        <div>
          <label class="lbl">Porcentaje PCL (%)</label>
          <input id="pcl" type="number" inputmode="decimal" min="0" max="100" step="0.1" placeholder="Ej: 18.5" />
          <div class="muted small">Rango esperado: 1 a 100. Se aplica tope de 180 SMLDV.</div>
        </div>
      </div>

      <div class="results">
        <div class="kpi">
          <div class="kpi__label">Equivalencia (SMLDV)</div>
          <div id="kpiSml" class="kpi__value">—</div>
        </div>
        <div class="kpi">
          <div class="kpi__label">SMLDV (COP)</div>
          <div id="kpiSmlDv" class="kpi__value">—</div>
        </div>
        <div class="kpi kpi--big">
          <div class="kpi__label">Indemnización estimada (COP)</div>
          <div id="kpiCop" class="kpi__value">—</div>
        </div>
      </div>

      <details class="muted small">
        <summary>Base normativa / criterio</summary>
        <ul>
          <li>Tope máximo incapacidad permanente: 180 SMLDV (referencias públicas: Decreto 3990/2007 y Decreto 780/2016, entre otras compilaciones).</li>
          <li>Equivalencia SMLDV vs. %PCL implementada por tramos: 1–5% = 14; 5–50% = 14 + (PCL-5)*3.5; &gt;50% = 180.</li>
        </ul>
      </details>
    </section>

    <!-- ====== DICTAMEN (PREMIUM GATED) ====== -->
    <section class="card">
      <div class="h">Dictamen preliminar (texto)</div>
      <textarea id="dictamen" class="mono" readonly></textarea>
      <div class="btnrow">
        <button id="btnCopyDictamen" class="btn btn--ghost">Copiar</button>
      </div>
    </section>

    <footer class="footer muted small">
      <div>Modo offline: si instalas la PWA, seguirá operando sin internet (según caché del Service Worker).</div>
      <div>Build: <code>assets/js/app.min.js</code> + <code>assets/js/license.min.js</code>.</div>
    </footer>
  </main>

  <!-- Carga de lógica (orden importa) -->
  <script src="assets/js/license.min.js"></script>
  <script src="assets/js/app.min.js"></script>

  <!-- SW register -->
  <script>
    (function(){
      const swEl = document.getElementById('swStatus');
      if (!('serviceWorker' in navigator)) { swEl.textContent = 'SW: no'; return; }
      navigator.serviceWorker.register('./sw.js')
        .then(()=>{ swEl.textContent = 'SW: ok'; })
        .catch(()=>{ swEl.textContent = 'SW: err'; });
    })();
    <script src="./assets/js/ui-tweaks.js"></script>
  </script>
  </body>
</html>
