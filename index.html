<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#08142b" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
                 font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:;
                 script-src 'self' 'unsafe-inline';
                 connect-src 'self';
                 base-uri 'self';
                 form-action 'self';
                 frame-ancestors 'none';" />
  <title>Calculadora PCL SOAT | PÃ©rdida de Capacidad Laboral</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <link rel="icon" type="image/png" href="icon.png" />

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&family=Playfair+Display:ital@1&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>

    :root{
      --bg:#08142b;
      --glass: rgba(255,255,255,0.08);
      --glass-2: rgba(255,255,255,0.05);
      --stroke: rgba(255,255,255,0.18);
      --stroke-2: rgba(79,172,254,0.55);
      --highlight:#4facfe;
      --text:#ffffff;
      --muted: rgba(255,255,255,0.65);
      --muted2: rgba(255,255,255,0.45);
      --danger:#ff4b4b;
      --wa:#25D366;
    }

    html{ color-scheme: dark; }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      min-height:100vh;
      font-family: 'Roboto', sans-serif;
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px 16px 28px;
      background: var(--bg);
      overflow-x:hidden;
      position:relative;
    }
    /* Fondo (similar a las capturas): imagen + blur + capa azul */
    body::before{
      content:"";
      position:fixed; inset:0;
      background:url('Diosa.png') center/cover no-repeat;
      filter: blur(8px);
      transform: scale(1.06);
      opacity:0.35;
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      background: radial-gradient(circle at top, rgba(16,37,74,0.92) 0%, rgba(5,10,21,0.96) 75%);
      z-index:-1;
    }

    /* Pantalla de licencia */
    #loginScreen{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:28px 18px;
      background: rgba(0,0,0,0.88);
      z-index:50000;
    }
    .login-card{
      width:min(420px, 100%);
      background: rgba(10, 20, 45, 0.85);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:22px;
      padding:26px 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      text-align:center;
      backdrop-filter: blur(10px);
    }
    .login-lock{ font-size:2.4rem; color:var(--highlight); margin-bottom:18px; }
    .login-input{
      width:100%;
      background: transparent;
      border:none;
      border-bottom: 1px solid var(--highlight);
      color:#fff;
      font-size:1.1rem;
      padding:12px 10px;
      text-align:center;
      outline:none;
      letter-spacing:2px;
    }
    .btn-enter{
      width:100%;
      margin-top:18px;
      background: rgba(79,172,254,0.14);
      border: 1px solid rgba(79,172,254,0.65);
      color: #d9f0ff;
      padding:14px 16px;
      border-radius:32px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:1px;
      transition: 0.2s;
    }
    .btn-enter:active{ transform: scale(0.99); background: rgba(79,172,254,0.28); }
    #msgError{ margin:14px 0 0; color:var(--danger); font-size:0.9rem; display:none; }

    /* Contenedor app */
    #appContent{
      width:100%;
      max-width: 520px;
      text-align:center;
      display:none;
      opacity:0;
      animation: fadeIn 0.55s forwards;
      padding-top: 8px;
    }
    @keyframes fadeIn{ to{ opacity:1; } }

    /* Header (como captura) */
    .kicker{
      margin-top: 26px;
      font-weight: 300;
      letter-spacing: 10px;
      text-transform: uppercase;
      opacity: 0.65;
      font-size: 1.05rem;
    }
    .main-title{
      margin: 10px 0 0;
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 3.1rem;
      line-height: 1.05;
    }
    .brand{
      margin-top: 10px;
      font-weight: 800;
      letter-spacing: 5px;
      text-transform: uppercase;
      font-size: 1.05rem;
      opacity: 0.9;
    }

.meaning{
      margin-top: 14px;
      font-weight: 800;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--muted);
      font-size: 1.05rem;
      opacity: 0.92;
    }
    .subtitle{
      margin-top: 10px;
      font-family: 'Playfair Display', serif;
      font-style: italic;
      color: var(--muted);
      font-size: 1.15rem;
      opacity: 0.85;
    }
    .site{
      display:inline-block;
      margin-top: 14px;
      color: rgba(79,172,254,0.72);
      text-decoration:none;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 700;
      font-size: 0.95rem;
    }

    /* Bloques (inputs / cajas) */
    .block{
      width:100%;
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 18px 18px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 14px 45px rgba(0,0,0,0.25);
    }
    .block + .block{ margin-top: 14px; }

    .field{
      display:flex;
      align-items:center;
      gap:14px;
      width:100%;
      padding: 20px 18px;
      background: var(--glass-2);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 18px;
      text-align:left;
    }
    .field-icon{
      width:32px;
      display:flex;
      justify-content:center;
      align-items:center;
      color: rgba(255,255,255,0.55);
      font-size: 1.35rem;
    }
    .field input, .field select{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: #fff;
      font-size: 1.25rem;
      font-weight: 700;
    }
    .field input::placeholder{ color: rgba(255,255,255,0.33); font-weight: 500; }
    .field select{
      -webkit-appearance:none;
      appearance:none;
      font-weight: 500;
      font-size: 1.2rem;
      letter-spacing: 0.5px;
    }
    .field select option{
      color:#0b1224;
      background:#e9eef7;
    }
    .field select option:disabled{
      color: rgba(11,18,36,0.55);
      background:#e9eef7;
    }
    .field .arrow{
      color: rgba(255,255,255,0.55);
      font-size: 1.15rem;
    }

    /* Caja valor base (monedas) */
    .money-box{
      display:flex;
      align-items:center;
      gap:14px;
      padding: 22px 18px;
      border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.16);
      text-align:left;
    }
    .money-box .money-icon{
      width:34px;
      display:flex;
      justify-content:center;
      align-items:center;
      color: rgba(255,255,255,0.65);
      font-size: 1.35rem;
    }
    .money-box .money-value{
      font-size: 1.65rem;
      font-weight: 900;
      color: rgba(79,172,254,0.85);
    }
    .money-box .money-sub{
      margin-top: 2px;
      font-size: 0.78rem;
      color: rgba(255,255,255,0.4);
      letter-spacing: 1px;
      text-transform: uppercase;
      font-weight: 700;
    }

    /* Resultado + WhatsApp (como captura) */
    .result-row{
      display:flex;
      align-items:stretch;
      gap: 14px;
      margin-top: 14px;
    }
    .result-main{
      flex:1;
      display:flex;
      align-items:center;
      gap: 14px;
      padding: 22px 18px;
      background: rgba(16, 32, 60, 0.55);
      border: 2px solid var(--stroke-2);
      border-radius: 18px;
      box-shadow: 0 0 28px rgba(79,172,254,0.18);
    }
    .result-main .result-icon{
      width:34px;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size: 1.35rem;
      color: rgba(79,172,254,0.9);
    }
    .result-main .result-value{
      font-size: 2.0rem;
      font-weight: 900;
      letter-spacing: 0.2px;
      color: rgba(79,172,254,0.95);
    }

    .wa-btn{
      width: 76px;
      border-radius: 18px;
      border: 2px solid rgba(37,211,102,0.65);
      background: rgba(0,0,0,0.22);
      display:flex;
      justify-content:center;
      align-items:center;
      color: var(--wa);
      font-size: 2.05rem;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(37,211,102,0.08);
    }
    .wa-btn:active{ transform: scale(0.99); background: rgba(37,211,102,0.12); }

    /* BotÃ³n tarifas */
    .btn-tarifas{
      width:100%;
      margin-top: 16px;
      padding: 18px 18px;
      border-radius: 34px;
      border: 1px solid rgba(79,172,254,0.30);
      background: rgba(79,172,254,0.10);
      color: rgba(79,172,254,0.85);
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 1.1rem;
      cursor:pointer;
    }
    .btn-tarifas:active{ transform: scale(0.99); background: rgba(79,172,254,0.18); }

    /* Footer (como captura) */
    .footer{
      margin-top: 22px;
      font-size: 0.95rem;
      color: rgba(255,255,255,0.5);
      letter-spacing: 2px;
      opacity: 0.75;
    }

    /* Modal tarifas (similar a captura) */
    .modal{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,0.35);
      z-index: 30000;
      justify-content:center;
      align-items:center;
      padding: 18px;
      backdrop-filter: blur(6px);
    }
    .modal-card{
      width: min(520px, 100%);
      background: rgba(10, 24, 52, 0.92);
      border: 2px solid rgba(79,172,254,0.40);
      border-radius: 22px;
      padding: 22px 20px 18px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
    }
    .modal-title{
      margin: 6px 0 18px;
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 1.4rem;
    }
    .tarifas-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      padding: 14px 0;
      border-top: 1px solid rgba(255,255,255,0.10);
    }
    .tarifas-row:first-of-type{ border-top:none; }
    .tarifas-left{
      text-align:left;
    }
    .tarifas-left .name{
      font-size: 1.12rem;
      font-weight: 500;
      color: rgba(255,255,255,0.85);
    }
    .tarifas-left .desc{
      margin-top: 2px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.45);
    }
    .tarifas-right{
      font-size: 1.35rem;
      font-weight: 900;
      color: rgba(79,172,254,0.90);
      padding-left: 12px;
      white-space:nowrap;
    }
    .subsection{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,0.10);
      text-align:left;
      color: rgba(255,255,255,0.75);
    }
    .subsection .subhead{
      font-size: 1.05rem;
      font-weight: 500;
      color: rgba(255,255,255,0.75);
      margin-bottom: 10px;
    }
    .subline{
      display:flex;
      justify-content:space-between;
      padding: 6px 0;
      color: rgba(255,255,255,0.65);
    }
    .subline b{
      color: rgba(255,255,255,0.86);
      font-weight: 700;
    }
    .subright{
      text-align:right;
      line-height: 1.05;
      white-space: nowrap;
    }
    .subright .sml{
      color: rgba(255,255,255,0.86);
      font-weight: 700;
    }
    .subright .cop{
      margin-top: 3px;
      color: rgba(79,172,254,0.90);
      font-weight: 900;
      letter-spacing: 0.3px;
    }
    .btn-close{
      width:100%;
      margin-top: 18px;
      padding: 18px 18px;
      border-radius: 34px;
      border:none;
      background: rgba(79,172,254,0.90);
      color: #061225;
      font-weight: 900;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-size: 1.1rem;
      cursor:pointer;
    }
    .btn-close:active{ transform: scale(0.99); background: rgba(79,172,254,1); }

    /* Accesibilidad mÃ­nima */
    .sr{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }

  
  
  .welcome{margin-top:8px;font-size:15px;font-weight:700;letter-spacing:.2px;opacity:.95;text-align:center;text-shadow:0 1px 2px rgba(0,0,0,.35);}
  .footer-status{font-weight:700;}
</style>
</head>
<body>

  <!-- LOGIN / LICENCIA -->
  <div id="loginScreen">
    <div class="login-card">
      <div class="login-lock"><i class="fa-solid fa-lock"></i></div>
      <input type="password" id="licenseCode" class="login-input" placeholder="CLAVE DE ACCESO" autocomplete="off" />
      <button class="btn-enter" id="btnEnter" onclick="verificarLicencia()">ENTRAR</button>
      <p id="msgError"></p>
    </div>
  </div>

  <!-- APP -->
  <main id="appContent">
    <div class="kicker">CALCULADORA</div>
    <h1 class="main-title">PCL SOAT</h1>
    <div class="meaning">PÃ‰RDIDA DE CAPACIDAD LABORAL</div>
    <div class="welcome" id="welcomeLine" style="display:none;"></div>

    <section class="block" style="margin-top: 26px;">
      <!-- AÃ±o gravable -->
      <div class="field">
        <div class="field-icon"><i class="fa-regular fa-calendar"></i></div>
        <label class="sr" for="yearSelect">AÃ±o gravable</label>
        <select id="yearSelect" onchange="actualizarBase()">
          <option value="2026">AÃ±o Gravable 2026</option>
          <option value="2025">AÃ±o Gravable 2025</option>
          <option value="2024">AÃ±o Gravable 2024</option>
          <option value="2023">AÃ±o Gravable 2023</option>
          <option value="2027" disabled>ðŸ”’ 2027 (Activar mediante suscripciÃ³n)</option>
        </select>
        <div class="arrow"><i class="fa-solid fa-chevron-down"></i></div>
      </div>

      <!-- % PCL -->
      <div class="field" style="margin-top: 14px;">
        <div class="field-icon"><i class="fa-solid fa-percent"></i></div>
        <label class="sr" for="pclInput">Porcentaje PCL</label>
        <input type="number" id="pclInput" placeholder="Ingrese % PCL (0 - 100)" step="0.1" min="0" max="100" inputmode="decimal" oninput="calcular()" />
      </div>

      <!-- Valor base (dÃ­a SMLDV) -->
      <div class="money-box" style="margin-top: 18px;">
        <div class="money-icon"><i class="fa-solid fa-coins"></i></div>
        <div>
          <div class="money-value" id="baseValue">$ 0</div>
          <div class="money-sub" id="baseLabel">Valor dÃ­a (SMLDV)</div>
        </div>
      </div>

      <!-- Resultado + WhatsApp -->
      <div class="result-row">
        <div class="result-main">
          <div class="result-icon"><i class="fa-solid fa-hand-holding-dollar"></i></div>
          <div class="result-value" id="totalResult">$ 0</div>
        </div>
        <button class="wa-btn" type="button" onclick="compartirWhatsApp()" aria-label="Compartir por WhatsApp">
          <i class="fa-brands fa-whatsapp"></i>
        </button>
      </div>

      <button class="btn-tarifas" type="button" onclick="abrirTarifas()">VER TARIFAS FIJAS</button>
    </section>

    <div class="footer" id="footerText">Â© 2026 Ing John A. Skinner S. | V26.1 (Licensed)</div>
  </main>

  <!-- MODAL TARIFAS -->
  <div id="tarifasModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tarifasTitle">
    <div class="modal-card">
      <div class="modal-title" id="tarifasTitle">TARIFAS FIJAS</div>

      <div class="tarifas-row">
        <div class="tarifas-left">
          <div class="name">Muerte / Funeral</div>
          <div class="desc">750 SMLDV</div>
        </div>
        <div class="tarifas-right" id="tMuerte">$ 0</div>
      </div>

      <div class="tarifas-row">
        <div class="tarifas-left">
          <div class="name">Transporte</div>
          <div class="desc">8.77 UVT (Ambulancia)</div>
        </div>
        <div class="tarifas-right" id="tTransporte">$ 0</div>
      </div>

      <div class="subsection">
        <div class="subhead">Topes Gastos MÃ©dicos:</div>

        <div class="subline">
          <span>Motos &lt; 200cc</span>
          <div class="subright">
            <div class="sml" id="tMotoSml">300 SMLDV</div>
            <div class="cop" id="tMotoCOP">$ 0</div>
          </div>
        </div>

        <div class="subline">
          <span>Otros / &gt; 200cc</span>
          <div class="subright">
            <div class="sml" id="tOtrosSml">800 SMLDV</div>
            <div class="cop" id="tOtrosCOP">$ 0</div>
          </div>
        </div>
      </div>

      <button class="btn-close" type="button" onclick="cerrarTarifas()">CERRAR</button>
    </div>
  </div>

  <script>
    // ----------------- PWA: registrar Service Worker -----------------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }

    // ----------------- Datos (certificados) -----------------
    const DATA = {
      '2026': { smlmv: 1750905, uvt: 52374 },
      '2025': { smlmv: 1423500, uvt: 49799 },
      '2024': { smlmv: 1300000, uvt: 47065 },
      '2023': { smlmv: 1160000, uvt: 42412 }
    };

    // WhatsApp (si quieres un nÃºmero fijo, ponlo aquÃ­ en formato internacional sin +)
    // Ej: const WHATSAPP_NUMBER = ''; // vacÃ­o = compartir a cualquier contacto (recomendado)
    const WHATSAPP_NUMBER = ''; // vacÃ­o = compartir a cualquier contacto (recomendado)

    function formatCOP(value, withDecimals=false) {
      try {
        return Number(value).toLocaleString('es-CO', {
          minimumFractionDigits: withDecimals ? 2 : 0,
          maximumFractionDigits: withDecimals ? 2 : 0
        });
      } catch(e) {
        const v = withDecimals ? Number(value).toFixed(2) : String(Math.round(value));
        return v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }
    }

    // ----------------- MembresÃ­a / Vigencia -----------------
    let CURRENT_USER = null;

    function parseYMDToUTCDate(ymd) {
      if (!ymd || typeof ymd !== 'string') return null;
      const m = ymd.trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
      const dt = new Date(Date.UTC(y, mo, d));
      if (isNaN(dt.getTime())) return null;
      return dt;
    }

    // Retorna dÃ­as restantes. 0 = vence hoy. Negativo = vencida.
    function daysUntil(ymd) {
      const end = parseYMDToUTCDate(ymd);
      if (!end) return null;
      const now = new Date();
      const todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
      const diffMs = end.getTime() - todayUTC.getTime();
      return Math.floor(diffMs / (24 * 60 * 60 * 1000));
    }

    function planLabel(planRaw) {
      const p = (planRaw || '').toString().trim().toLowerCase();
      if (!p) return 'PREMIUM';
      if (p === 'pro' || p === 'premium') return 'PREMIUM';
      if (p === 'demo') return 'DEMO';
      return p.toUpperCase();
    }

    function aplicarUIUsuario() {
      const welcome = document.getElementById('welcomeLine');
      const footer = document.getElementById('footerText');

      if (!CURRENT_USER) {
        if (welcome) welcome.style.display = 'none';
        if (footer && footer.dataset.baseText) footer.textContent = footer.dataset.baseText;
        return;
      }

      // Header: Bienvenido, Nombre
      if (welcome) {
        const nombre = (CURRENT_USER.nombre || '').trim() || 'Usuario';
        welcome.textContent = `Bienvenido, ${nombre}`;
        welcome.style.display = 'block';
      }

      // Footer: licencia + dÃ­as
      const label = planLabel(CURRENT_USER.plan);
      const d = daysUntil(CURRENT_USER.vence);

      let statusText = '';
      if (d === null) {
        statusText = `Licencia ${label} activa`;
      } else if (d >= 0) {
        statusText = `Licencia ${label} activa Â· vence en ${d} dÃ­a${d === 1 ? '' : 's'}`;
      } else {
        statusText = 'LICENCIA VENCIDA Â· active o renueve su suscripciÃ³n';
      }

      if (footer) {
        if (!footer.dataset.baseText) footer.dataset.baseText = footer.textContent;
        footer.innerHTML = `${footer.dataset.baseText} | <span class="footer-status">${statusText}</span>`;
      }

      if (d !== null && d < 0) {
        cerrarSesionPorVencimiento();
      }
    }

    function cerrarSesionPorVencimiento() {
      localStorage.removeItem('valora_user');
      localStorage.removeItem('valora_code');
      CURRENT_USER = null;
      mostrarLogin('LICENCIA VENCIDA');
    }

    // ----------------- Pantallas -----------------
    function mostrarLogin(mensaje='') {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('appContent').style.display = 'none';

      const input = document.getElementById('licenseCode');
      input.value = '';
      setTimeout(() => input.focus(), 50);

      const msg = document.getElementById('msgError');
      msg.textContent = mensaje || '';
      msg.style.display = mensaje ? 'block' : 'none';
    }

    function mostrarApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';
      actualizarBase();
      aplicarUIUsuario();
    }

    // Enter en login
    document.addEventListener('keydown', (e) => {
      if (document.getElementById('loginScreen').style.display === 'flex' && e.key === 'Enter') {
        verificarLicencia();
      }
    });

    // ----------------- Inicio -----------------
    window.addEventListener('load', () => {
      const savedUser = localStorage.getItem('valora_user');

      if (savedUser) {
        try {
          const user = JSON.parse(savedUser);
          if (user && user.estado === 'activo') {
            CURRENT_USER = user;
            const d = daysUntil(CURRENT_USER.vence);
            if (d !== null && d < 0) {
              cerrarSesionPorVencimiento();
              return;
            }
            mostrarApp();
            return;
          }
        } catch (_) {}
      }
      mostrarLogin();
    });

    // ----------------- Licencia -----------------
    async function verificarLicencia() {
      const codigo = (document.getElementById('licenseCode').value || '').trim();
      const btn = document.getElementById('btnEnter');
      const msg = document.getElementById('msgError');

      if (!codigo) return;

      btn.disabled = true;
      btn.textContent = '...';
      msg.style.display = 'none';
      msg.textContent = '';

      try {
        const res = await fetch('./licencia_valora.json', { cache: 'no-store' });
        const data = await res.json();

        if (data && data[codigo]) {
          const cliente = data[codigo];

          if (cliente.estado === 'activo') {
            const d = daysUntil(cliente.vence);
            if (d !== null && d < 0) {
              msg.textContent = 'LICENCIA VENCIDA';
              msg.style.display = 'block';
              return;
            }

            localStorage.setItem('valora_user', JSON.stringify(cliente));
            localStorage.setItem('valora_code', codigo);
            CURRENT_USER = cliente;
            mostrarApp();
            return;
          }

          msg.textContent = (cliente.mensaje || 'Acceso denegado').toString().replace(/^"|"$/g,'');
          msg.style.display = 'block';
        } else {
          msg.textContent = 'Clave incorrecta';
          msg.style.display = 'block';
        }
      } catch (e) {
        msg.textContent = 'Sin conexiÃ³n';
        msg.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ENTRAR';
      }
    }

    // ----------------- CÃ¡lculo -----------------
    function actualizarBase() {
      const year = document.getElementById('yearSelect').value;
      const smlmv = DATA[year].smlmv;
      const smldv = smlmv / 30;

      document.getElementById('baseValue').textContent = '$ ' + formatCOP(smldv, true);
      document.getElementById('baseLabel').textContent = 'Valor dÃ­a (SMLDV)';

      const ft = document.getElementById('footerText');
      if (ft) {
        ft.dataset.baseText = `Â© ${year} Ing John A. Skinner S. | V26.1 (Licensed)`;
        ft.textContent = ft.dataset.baseText;
      }

      aplicarUIUsuario();
      calcular();
    }

    function calcular() {
      const year = document.getElementById('yearSelect').value;
      let pcl = parseFloat(document.getElementById('pclInput').value);
      if (!isFinite(pcl)) pcl = 0;
      if (pcl < 0) pcl = 0;
      if (pcl > 100) pcl = 100;

      const smlmv = DATA[year].smlmv;
      const smldv = smlmv / 30;

      let dias = 0;
      if (pcl > 0) {
        if (pcl <= 5) dias = 14;
        else if (pcl >= 50) dias = 180;
        else dias = 14 + ((pcl - 5) * 3.68);
      }

      const total = smldv * dias;
      document.getElementById('totalResult').textContent = '$ ' + formatCOP(Math.round(total), false);
    }

    // ----------------- Tarifas fijas (modal) -----------------
    function abrirTarifas() {
      const year = document.getElementById('yearSelect').value;
      const { smlmv, uvt } = DATA[year];
      const smldv = smlmv / 30;

      const muerte = 750 * smldv;
      const transporte = 8.77 * uvt;

      document.getElementById('tarifasTitle').textContent = `TARIFAS FIJAS ${year}`;
      document.getElementById('tMuerte').textContent = '$ ' + formatCOP(muerte, false);
      document.getElementById('tTransporte').textContent = '$ ' + formatCOP(transporte, true);

      const moto = 300 * smldv;
      const otros = 800 * smldv;

      document.getElementById('tMotoSml').textContent = '300 SMLDV';
      document.getElementById('tOtrosSml').textContent = '800 SMLDV';
      document.getElementById('tMotoCOP').textContent = '$ ' + formatCOP(moto, false);
      document.getElementById('tOtrosCOP').textContent = '$ ' + formatCOP(otros, false);

      document.getElementById('tarifasModal').style.display = 'flex';
    }

    function cerrarTarifas() {
      document.getElementById('tarifasModal').style.display = 'none';
    }

    document.getElementById('tarifasModal').addEventListener('click', (e) => {
      if (e.target && e.target.id === 'tarifasModal') cerrarTarifas();
    });

    // ----------------- WhatsApp / Compartir -----------------
    function _diasDesdePCL(pcl) {
      let dias = 0;
      if (pcl > 0) {
        if (pcl <= 5) dias = 14;
        else if (pcl >= 50) dias = 180;
        else dias = 14 + ((pcl - 5) * 3.68);
      }
      return dias;
    }

    function _fmtDias(d) {
      if (!isFinite(d)) return '0';
      const r = Math.round(d);
      if (Math.abs(d - r) < 1e-9) return String(r);
      return d.toFixed(1);
    }

    function compartirWhatsApp() {
      const year = document.getElementById('yearSelect').value;
      let pcl = parseFloat(document.getElementById('pclInput').value);
      if (!isFinite(pcl)) pcl = 0;
      if (pcl < 0) pcl = 0;
      if (pcl > 100) pcl = 100;

      const { smlmv } = DATA[year];
      const smldv = smlmv / 30;

      const dias = _diasDesdePCL(pcl);
      const total = smldv * dias;

      const pclFmt = (Math.round(pcl * 10) / 10).toFixed(1).replace(/\.0$/, '');
      const diasFmt = _fmtDias(dias);
      const valorCOP = '$ ' + formatCOP(Math.round(total), false) + ' COP';

      const msg =
`CÃLCULO REFERENCIAL DE INDEMNIZACIÃ“N â€“ SOAT ${year}

Resultado ingresado: PCL ${pclFmt}%
Equivalencia normativa: ${diasFmt} dÃ­as SMLDV
EstimaciÃ³n en COP: ${valorCOP}

Referencia: Tabla de indemnizaciones â€“ Decreto 780 de 2016 (Art. 2.6.1.4.2.3) y valores oficiales del aÃ±o ${year}.

Â¿Desea orientaciÃ³n para presentar la reclamaciÃ³n?`;

      // 1) Compartir nativo (WhatsApp/Correo/Apps) cuando estÃ© disponible
      if (navigator.share) {
        navigator.share({
          title: `CÃ¡lculo referencial SOAT ${year}`,
          text: msg
        }).catch(() => {});
        return;
      }

      // 2) WhatsApp universal (sin nÃºmero fijo) + fallback a portapapeles
      const encoded = encodeURIComponent(msg);

      // Si defines WHATSAPP_NUMBER (ej. "573001234567"), enviarÃ¡ a ese nÃºmero.
      // Si estÃ¡ vacÃ­o, abre WhatsApp para elegir contacto.
      const waUrl = WHATSAPP_NUMBER
        ? `https://wa.me/${WHATSAPP_NUMBER}?text=${encoded}`
        : `https://wa.me/?text=${encoded}`;

      // Intento primero esquema whatsapp:// en mÃ³viles, si falla usa wa.me
      const deepLink = `whatsapp://send?text=${encoded}`;

      // HeurÃ­stica: en mÃ³vil intenta deep link; en desktop abre wa.me
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
      if (isMobile) {
        const opened = window.open(deepLink, '_blank');
        // algunos navegadores bloquean/ignoran deep link: abrimos wa.me como respaldo
        setTimeout(() => {
          try { if (!opened || opened.closed) window.open(waUrl, '_blank', 'noopener'); } catch(_) { window.open(waUrl, '_blank', 'noopener'); }
        }, 400);
      } else {
        window.open(waUrl, '_blank', 'noopener');
      }

      // Fallback adicional: copiar al portapapeles (por si WhatsApp no abre)
      if (navigator.clipboard) {
        navigator.clipboard.writeText(msg).catch(() => {});
      }
    }
</script>
</body>
</html>