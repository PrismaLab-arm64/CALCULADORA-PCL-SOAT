(function(){"use strict";
const SMMLV={"2024": 1300000, "2025": 1423500, "2026": 1750905};
const $=id=>document.getElementById(id);
const fmtCOP=n=>isFinite(n)?n.toLocaleString("es-CO",{style:"currency",currency:"COP",maximumFractionDigits:0}):"â€”";
const fmtNum=n=>isFinite(n)?n.toLocaleString("es-CO",{maximumFractionDigits:2}):"â€”";
function smlEquivalence(pcl){if(!isFinite(pcl)||pcl<=0)return NaN;if(pcl<=5)return 14; if(pcl<=50)return 14+((pcl-5)*3.5); return 180;}
function smldvFromSmmlv(v){return v/30;}
function todayISO(){const d=new Date();const yyyy=d.getFullYear();const mm=String(d.getMonth()+1).padStart(2,"0");const dd=String(d.getDate()).padStart(2,"0");return `${yyyy}-${mm}-${dd}`;}
function buildDictamen({year,pcl,sml,smlDv,cop,isPremium,user,plan,daysLeft}){
  const head=`DICTAMEN PRELIMINAR (â€” NO CONSTITUYE ASESORÃA JURÃDICA)\n`;
  const base=`AÃ±o base SMMLV: ${year}\nPCL reportada: ${isFinite(pcl)?pcl:"â€”"}%\nEquivalencia aplicada (SMLDV): ${fmtNum(sml)}\nValor SMLDV (COP): ${fmtCOP(smlDv)}\nIndemnizaciÃ³n estimada (COP): ${fmtCOP(cop)}\n\n`;
  const norm=`Criterio de cÃ¡lculo: regla por tramos con tope de 180 SMLDV para IP (SOAT).\n\n`;
  const prem=isPremium?`Licencia: ${(plan||"premium")}\nUsuario: ${(user||"")}\nDÃ­as restantes: ${daysLeft}\n`:"";
  return head+base+norm+prem;
}
function setMsg(el,text,ok){el.className="msg "+(ok?"ok":"bad");el.textContent=text;}
function updateNet(){const el=$("netStatus");el.textContent=navigator.onLine?"Online":"Offline";}
window.addEventListener("online",updateNet);window.addEventListener("offline",updateNet);

let premium={ok:false,user:"",plan:"",daysLeft:null,features:{}};
async function refreshPremiumFromStored(){
  const token=window.PCLSOAT_LICENSE?.loadToken?.()||"";
  if(!token){premium={ok:false,user:"",plan:"",daysLeft:null,features:{}};return premium;}
  const res=await window.PCLSOAT_LICENSE.verifyToken(token);
  premium=res.ok?res:{ok:false,reason:res.reason||"Licencia invÃ¡lida"};
  return premium;
}
function renderPremiumUI(){
  const st=$("premiumStatus"),u=$("premiumUser"),d=$("premiumDays");
  if(premium.ok){
    st.innerHTML='Estado: <b>PREMIUM</b>';
    u.style.display="block"; d.style.display="block";
    u.textContent="Usuario: "+(premium.user||"");
    d.textContent="DÃ­as restantes: "+String(premium.daysLeft);
  }else{
    st.innerHTML='Estado: <b>FREE</b>';
    u.style.display="none"; d.style.display="none";
  }
}
function applyPremiumGates(dictText){
  const dict=$("dictamen"),btn=$("btnCopyDictamen");
  if(!premium.ok){
    dict.value="ðŸ”’ Dictamen preliminar disponible solo en versiÃ³n PREMIUM.";
    btn.style.display="none";
  }else{
    dict.value=dictText;
    btn.style.display="inline-block";
  }
}
function computeAndRender(){
  const year=parseInt($("year").value,10);
  const pcl=parseFloat($("pcl").value);
  const sm=SMMLV[String(year)] ?? SMMLV[year];
  const smNum=Number(sm);
  const smldv=smldvFromSmmlv(smNum);
  const eq=smlEquivalence(pcl);
  const cop=eq*smldv;

  $("smmlvInfo").textContent=isFinite(smNum)?`SMMLV: ${fmtCOP(smNum)} | SMLDV: ${fmtCOP(smldv)}`:"SMMLV no definido";
  $("kpiSml").textContent=isFinite(eq)?fmtNum(eq):"â€”";
  $("kpiSmlDv").textContent=isFinite(smldv)?fmtCOP(smldv):"â€”";
  $("kpiCop").textContent=isFinite(cop)?fmtCOP(cop):"â€”";

  const dictText=buildDictamen({year,pcl,sml:eq,smlDv:smldv,cop,isPremium:premium.ok,user:premium.user,plan:premium.plan,daysLeft:premium.daysLeft});
  applyPremiumGates(dictText);
}
function openModal(open){$("licenseModal").setAttribute("aria-hidden",open?"false":"true");}

async function init(){
  updateNet();
  $("year").addEventListener("change",computeAndRender);
  $("pcl").addEventListener("input",computeAndRender);

  $("btnOpenLicense").addEventListener("click",()=>{
    $("licenseToken").value=window.PCLSOAT_LICENSE.loadToken()||"";
    setMsg($("licenseMsg"),"Pega el token y valida.",true);
    openModal(true);
  });
  $("btnCloseLicense").addEventListener("click",()=>openModal(false));
  $("btnClearLicense").addEventListener("click",async()=>{
    window.PCLSOAT_LICENSE.clearToken();
    await refreshPremiumFromStored();
    renderPremiumUI();
    computeAndRender();
  });
  $("btnValidateLicense").addEventListener("click",async()=>{
    const token=$("licenseToken").value.trim();
    if(!token) return setMsg($("licenseMsg"),"Pega un token primero.",false);
    const res=await window.PCLSOAT_LICENSE.verifyToken(token);
    if(!res.ok){setMsg($("licenseMsg"),res.reason||"Licencia invÃ¡lida.",false);return;}
    window.PCLSOAT_LICENSE.saveToken(token);
    premium=res;
    renderPremiumUI();
    computeAndRender();
    setMsg($("licenseMsg"),"Licencia vÃ¡lida. PREMIUM activo.",true);
  });
  $("btnCopyState").addEventListener("click",async()=>{
    const s=premium.ok?{ok:true,user:premium.user,plan:premium.plan,exp:premium.exp,daysLeft:premium.daysLeft}:{ok:false,reason:premium.reason||"FREE"};
    await navigator.clipboard.writeText(JSON.stringify(s,null,2));
    setMsg($("licenseMsg"),"Estado copiado.",true);
  });
  $("btnCopyDictamen").addEventListener("click",async()=>{
    if(!premium.ok) return;
    await navigator.clipboard.writeText($("dictamen").value);
  });

  await refreshPremiumFromStored();
  renderPremiumUI();
  computeAndRender();
}
document.addEventListener("DOMContentLoaded",init);
})();