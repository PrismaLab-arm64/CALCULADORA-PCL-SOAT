const S="Sk1nn3r%%2025";

async function p(e){
  try{
    if(!S||S.trim().length<8) return {ok:!1,reason:"SECRET vacío o inválido en la PWA. Mantiene modo FREE."};

    const parts=(e||"").trim().split(".");
    if(parts.length!==3) return {ok:!1,reason:"Token inválido: formato esperado header.payload.signature"};

    const hp=parts[0]+"."+parts[1];
    const sig=parts[2];

    // Calcula firma esperada con el mismo HMAC-SHA256
    const expected=await f(S,hp);
    if(expected!==sig) return {ok:!1,reason:"Firma inválida. SECRET no coincide o token alterado."};

    // Decodifica payload
    const payloadJson=new TextDecoder().decode(u(parts[1]));
    const payload=JSON.parse(payloadJson);

    const expMs=payload.exp ? Date.parse(payload.exp) : 0;
    if(!expMs||isNaN(expMs)) return {ok:!1,reason:"Token sin vencimiento (exp) válido."};

    const now=d();
    if(expMs<=now) return {ok:!1,reason:"Licencia vencida."};

    const daysLeft=E(expMs);
    const user=(payload.user||payload.usuario||"").toString();
    const plan=(payload.plan||"").toString();
    const features=payload
