<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PCL-SOAT — Generador/Validador SIMPLE (Offline)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:940px;margin:24px auto;padding:0 14px;line-height:1.35}
    .card{border:1px solid rgba(0,0,0,.12);border-radius:14px;padding:14px;margin:12px 0}
    label{display:block;font-size:12px;opacity:.8;margin:10px 0 6px}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.18)}
    textarea{min-height:96px;font-family:ui-monospace,Consolas,monospace}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.18);cursor:pointer;background:white}
    .ok{color:#0a7} .bad{color:#c00}
    .mono{font-family:ui-monospace,Consolas,monospace;font-size:12px}
    .hint{font-size:12px;opacity:.8}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.15);font-size:12px}
  </style>
</head>
<body>
  <h2>Generador/Validador SIMPLE — CALCULADORA PCL SOAT (Offline)</h2>
  <p class="hint">
    Abre este archivo con doble clic (sin internet). Genera tokens premium con HMAC-SHA256.
    <br><b>Modo DEMO:</b> si eliges <span class="pill">Demo</span>, el vencimiento se pone automático a <b>30 días</b>.
  </p>

  <div class="card">
    <h3>1) Datos</h3>

    <div class="row">
      <div>
        <label>Usuario (nombre visible)</label>
        <input id="user" type="text" placeholder="Ej: Diego Rojas / Abogado X / Cliente Y" />
      </div>
      <div>
        <label>Plan</label>
        <select id="plan">
          <option value="Demo" selected>Demo (30 días automático)</option>
          <option value="premium">premium</option>
          <option value="pro">pro</option>
          <option value="enterprise">enterprise</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Vencimiento (calendario)</label>
        <input id="exp" type="date" />
        <div class="hint">Si el plan es Demo, este campo se calcula solo (hoy + 30 días).</div>
      </div>
      <div>
        <label>ID licencia (opcional)</label>
        <input id="lic_id" type="text" placeholder="Si lo dejas vacío se genera solo" />
      </div>
    </div>

    <label>Features (JSON) — opcional</label>
    <textarea id="features">{ "whatsapp": true, "dictamen": true }</textarea>

    <div class="btns">
      <button id="btnGenerate">Generar token</button>
      <button id="btnCopy">Copiar token</button>
      <button id="btnVerify">Verificar token aquí</button>
      <button id="btnReset">Limpiar</button>
    </div>

    <div id="msg" class="hint" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>2) Token</h3>
    <label>Token</label>
    <textarea id="token" placeholder="Aquí aparecerá el token..."></textarea>

    <label>Payload decodificado (solo lectura)</label>
    <textarea id="payloadOut" readonly></textarea>
  </div>

<script>
  // ================== CONFIG (SECRET embebido) ==================
  // AVISO: Si este archivo se comparte, el SECRET queda expuesto.
  // Para un modelo comercial fuerte, migra a firma asimétrica (privada offline / pública en PWA).
  const SECRET = "Sk1nn3r%%2025";

  // ===== Utils =====
  const $ = (id) => document.getElementById(id);

  function b64uEncode(bytes) {
    let bin = "";
    const arr = new Uint8Array(bytes);
    for (let i=0; i<arr.length; i++) bin += String.fromCharCode(arr[i]);
    return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }

  function b64uToBytes(b64u) {
    const b64 = b64u.replace(/-/g, "+").replace(/_/g, "/") + "===".slice((b64u.length + 3) % 4);
    const str = atob(b64);
    const bytes = new Uint8Array(str.length);
    for (let i=0; i<str.length; i++) bytes[i] = str.charCodeAt(i);
    return bytes;
  }

  function textToBytes(s) { return new TextEncoder().encode(s); }
  function bytesToText(b) { return new TextDecoder().decode(b); }

  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function addDaysISO(days) {
    const d = new Date();
    d.setDate(d.getDate() + Number(days||0));
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function randId() {
    const a = crypto.getRandomValues(new Uint8Array(6));
    return "PCL-" + b64uEncode(a);
  }

  async function hmacSha256(secret, message) {
    const key = await crypto.subtle.importKey(
      "raw",
      textToBytes(secret),
      { name: "HMAC", hash: "SHA-256" },
      false,
      ["sign"]
    );
    const sig = await crypto.subtle.sign("HMAC", key, textToBytes(message));
    return b64uEncode(sig);
  }

  function setMsg(text, ok=true) {
    $("msg").innerHTML = ok ? `<span class="ok">✅ ${text}</span>` : `<span class="bad">❌ ${text}</span>`;
  }

  function parseFeatures() {
    const raw = ($("features").value || "").trim();
    if (!raw) return {};
    const obj = JSON.parse(raw);
    if (typeof obj !== "object" || obj === null) throw new Error("features no es objeto");
    return obj;
  }

  function applyDemoAutoExp() {
    const plan = $("plan").value;
    if (plan === "Demo") {
      $("exp").value = addDaysISO(30);
      $("exp").disabled = true;
    } else {
      $("exp").disabled = false;
      if (!$("exp").value) $("exp").value = addDaysISO(30); // valor sugerido
    }
  }

  $("plan").addEventListener("change", applyDemoAutoExp);
  // inicial
  applyDemoAutoExp();

  // ===== Generate =====
  $("btnGenerate").addEventListener("click", async () => {
    try{
      const user = $("user").value.trim();
      const plan = $("plan").value.trim();
      const exp = $("exp").value.trim();
      const lic_id = ($("lic_id").value || "").trim() || randId();
      const features = parseFeatures();

      if (!SECRET) return setMsg("SECRET no configurado en este archivo.", false);
      if (!user) return setMsg("Falta Usuario.", false);
      if (!exp) return setMsg("Falta vencimiento.", false);

      const payload = {
        lic_id,
        user,
        plan,
        exp,
        features,
        issued_at: todayISO()
      };

      const payloadJson = JSON.stringify(payload);
      const payloadB64u = b64uEncode(textToBytes(payloadJson));

      // FORMATO DE TOKEN (simple, 2 partes): payload.signature
      // Esto coincide con el generador original que firmaba el payloadB64u.
      const sigB64u = await hmacSha256(SECRET, payloadB64u);
      const token = `${payloadB64u}.${sigB64u}`;

      $("token").value = token;
      $("payloadOut").value = JSON.stringify(payload, null, 2);
      setMsg("Token generado.");
    }catch(e){
      setMsg(e.message || String(e), false);
    }
  });

  // ===== Copy =====
  $("btnCopy").addEventListener("click", async () => {
    const token = $("token").value.trim();
    if (!token) return setMsg("No hay token para copiar.", false);
    await navigator.clipboard.writeText(token);
    setMsg("Token copiado al portapapeles.");
  });

  // ===== Verify local =====
  $("btnVerify").addEventListener("click", async () => {
    try{
      const token = $("token").value.trim();
      if (!SECRET) return setMsg("SECRET no configurado.", false);
      if (!token || !token.includes(".")) return setMsg("Token inválido.", false);

      const parts = token.split(".");
      if (parts.length !== 2) return setMsg("Token inválido: se esperan 2 partes payload.signature", false);

      const payloadB64u = parts[0];
      const sigB64u = parts[1];

      const expected = await hmacSha256(SECRET, payloadB64u);
      if (expected !== sigB64u) return setMsg("Firma NO coincide (token modificado).", false);

      const payload = JSON.parse(bytesToText(b64uToBytes(payloadB64u)));
      $("payloadOut").value = JSON.stringify(payload, null, 2);

      if (!payload.exp) return setMsg("Payload: exp faltante.", false);
      if (payload.exp < todayISO()) return setMsg("Licencia vencida.", false);

      setMsg("Token válido y vigente.");
    }catch(e){
      setMsg(e.message || String(e), false);
    }
  });

  $("btnReset").addEventListener("click", () => {
    $("user").value = "";
    $("lic_id").value = "";
    $("token").value = "";
    $("payloadOut").value = "";
    $("features").value = '{ "whatsapp": true, "dictamen": true }';
    $("plan").value = "Demo";
    applyDemoAutoExp();
    setMsg("Limpio.");
  });
</script>
</body>
</html>
