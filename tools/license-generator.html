<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PCL-SOAT — Generador de Licencias (Offline)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:900px;margin:24px auto;padding:0 14px;line-height:1.35}
    .card{border:1px solid rgba(0,0,0,.12);border-radius:14px;padding:14px;margin:12px 0}
    label{display:block;font-size:12px;opacity:.8;margin:10px 0 6px}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.18)}
    textarea{min-height:96px;font-family:ui-monospace,Consolas,monospace}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.18);cursor:pointer;background:white}
    .ok{color: #0a7}
    .bad{color:#c00}
    .mono{font-family:ui-monospace,Consolas,monospace;font-size:12px}
    .hint{font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <h2>Generador de Licencias — CALCULADORA PCL SOAT (Offline)</h2>
  <p class="hint">
    Abre este archivo con doble clic (sin internet). Genera tokens premium con HMAC-SHA256.
    <br><b>Importante:</b> El <span class="mono">SECRET</span> debe ser el mismo que uses en la PWA (<span class="mono">license.js</span>).
  </p>

  <div class="card">
    <h3>1) Configuración</h3>

    <label>SECRET (clave de firma)</label>
    <input id="secret" type="password" placeholder="Pega aquí tu SECRET" />

    <div class="row">
      <div>
        <label>Usuario (nombre visible)</label>
        <input id="user" type="text" placeholder="Ej: Diego Rojas / Abogado X / Cliente Y" />
      </div>
      <div>
        <label>Vencimiento (YYYY-MM-DD)</label>
        <input id="exp" type="text" placeholder="Ej: 2026-12-31" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Plan</label>
        <select id="plan">
	<option value="Demo">Demo</option>
          <option value="premium">premium</option>
          <option value="pro">pro</option>
          <option value="enterprise">enterprise</option>
        </select>
      </div>
      <div>
        <label>ID licencia (opcional)</label>
        <input id="lic_id" type="text" placeholder="Si lo dejas vacío se genera solo" />
      </div>
    </div>

    <label>Features (JSON)</label>
    <textarea id="features">{ "y2027": true, "whatsapp": true }</textarea>

    <div class="btns">
      <button id="btnGenerate">Generar token</button>
      <button id="btnCopy">Copiar token</button>
      <button id="btnVerify">Verificar token aquí</button>
      <button id="btnReset">Limpiar</button>
    </div>

    <div id="msg" class="hint" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>2) Token generado</h3>
    <label>Token</label>
    <textarea id="token" placeholder="Aquí aparecerá el token..."></textarea>

    <label>Payload decodificado (solo lectura)</label>
    <textarea id="payloadOut" readonly></textarea>
  </div>

<script>
  // ===== Utils =====
  const $ = (id) => document.getElementById(id);

  function b64uEncode(bytes) {
    let bin = "";
    const arr = new Uint8Array(bytes);
    for (let i=0; i<arr.length; i++) bin += String.fromCharCode(arr[i]);
    return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }

  function b64uToBytes(b64u) {
    const b64 = b64u.replace(/-/g, "+").replace(/_/g, "/") + "===".slice((b64u.length + 3) % 4);
    const str = atob(b64);
    const bytes = new Uint8Array(str.length);
    for (let i=0; i<str.length; i++) bytes[i] = str.charCodeAt(i);
    return bytes;
  }

  function textToBytes(s) { return new TextEncoder().encode(s); }
  function bytesToText(b) { return new TextDecoder().decode(b); }

  function isISODate(s){
    return /^(\d{4})-(\d{2})-(\d{2})$/.test(String(s||"").trim());
  }

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function randId(){
    const a = crypto.getRandomValues(new Uint8Array(6));
    return "PCL-" + b64uEncode(a);
  }

  async function hmacSha256(secret, message){
    const key = await crypto.subtle.importKey(
      "raw",
      textToBytes(secret),
      { name: "HMAC", hash: "SHA-256" },
      false,
      ["sign"]
    );
    const sig = await crypto.subtle.sign("HMAC", key, textToBytes(message));
    return b64uEncode(sig);
  }

  function setMsg(text, ok=true){
    $("msg").innerHTML = ok ? `<span class="ok">✅ ${text}</span>` : `<span class="bad">❌ ${text}</span>`;
  }

  function parseFeatures(){
    try {
      const obj = JSON.parse($("features").value || "{}");
      if (typeof obj !== "object" || obj === null) throw new Error("features no es objeto");
      return obj;
    } catch(e){
      throw new Error("Features inválidas: JSON mal formado");
    }
  }

  // ===== Generate =====
  $("btnGenerate").addEventListener("click", async () => {
    try{
      const secret = $("secret").value.trim();
      const user = $("user").value.trim();
      const exp = $("exp").value.trim();
      const plan = $("plan").value.trim();
      const lic_id = ($("lic_id").value || "").trim() || randId();
      const features = parseFeatures();

      if (!secret) return setMsg("Falta SECRET.", false);
      if (!user) return setMsg("Falta Usuario.", false);
      if (!isISODate(exp)) return setMsg("Vencimiento inválido. Usa YYYY-MM-DD.", false);

      const payload = {
        lic_id,
        user,
        plan,
        exp,
        features,
        issued_at: todayISO()
      };

      const payloadJson = JSON.stringify(payload);
      const payloadB64u = b64uEncode(textToBytes(payloadJson));
      const sigB64u = await hmacSha256(secret, payloadB64u);
      const token = `${payloadB64u}.${sigB64u}`;

      $("token").value = token;
      $("payloadOut").value = JSON.stringify(payload, null, 2);
      setMsg("Token generado.");
    }catch(e){
      setMsg(e.message || String(e), false);
    }
  });

  // ===== Copy =====
  $("btnCopy").addEventListener("click", async () => {
    const token = $("token").value.trim();
    if (!token) return setMsg("No hay token para copiar.", false);
    await navigator.clipboard.writeText(token);
    setMsg("Token copiado al portapapeles.");
  });

  // ===== Verify local =====
  $("btnVerify").addEventListener("click", async () => {
    try{
      const secret = $("secret").value.trim();
      const token = $("token").value.trim();
      if (!secret) return setMsg("Falta SECRET para verificar.", false);
      if (!token || !token.includes(".")) return setMsg("Token inválido.", false);

      const [payloadB64u, sigB64u] = token.split(".", 2);
      const expected = await hmacSha256(secret, payloadB64u);
      if (expected !== sigB64u) return setMsg("Firma NO coincide (SECRET incorrecto o token modificado).", false);

      const payload = JSON.parse(bytesToText(b64uToBytes(payloadB64u)));
      $("payloadOut").value = JSON.stringify(payload, null, 2);

      if (!payload.exp || !isISODate(payload.exp)) return setMsg("Payload: exp inválido.", false);
      if (payload.exp < todayISO()) return setMsg("Licencia vencida.", false);

      setMsg("Token válido y vigente.");
    }catch(e){
      setMsg(e.message || String(e), false);
    }
  });

  $("btnReset").addEventListener("click", () => {
    $("user").value = "";
    $("exp").value = "";
    $("lic_id").value = "";
    $("token").value = "";
    $("payloadOut").value = "";
    setMsg("Limpio.");
  });
</script>
</body>
</html>
