<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Generador de Licencias — PCL/SOAT</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--txt:#e7edf7;--muted:#9fb0c6;--line:rgba(255,255,255,.12);--ok:#3ddc97;--bad:#ff5c73;--btn:#1a2440}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,var(--bg),#070b14); color:var(--txt)}
    main{max-width:820px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:8px 0 6px}
    p{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1626;color:var(--txt);outline:none}
    textarea{min-height:110px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{padding:11px 12px;border-radius:12px;border:1px solid var(--line);background:var(--btn);color:var(--txt);cursor:pointer}
    button:active{transform:scale(.99)}
    .msg{margin-top:10px;font-size:13px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <main>
    <h1>Generador de Licencias — PCL / SOAT</h1>
    <p class="tiny">Titular → Plan → Generar → Copiar</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Titular (nombre visible)</label>
          <input id="user" type="text" placeholder="Ej: Diego Rojas / Cliente X" autocomplete="off" />
        </div>
        <div>
          <label>Plan (automático)</label>
          <select id="plan">
            <option value="demo" selected>Demo (30 días)</option>
            <option value="pro">Pro (6 meses)</option>
            <option value="premium">Premium (12 meses)</option>
          </select>
        </div>
      </div>

      <details class="card" style="margin-top:12px">
  <summary class="tiny" style="cursor:pointer">Opciones avanzadas (features)</summary>
  <div style="margin-top:10px">
    <label>Features (JSON)</label>
    <textarea id="features">{ "whatsapp": true, "dictamen": true }</textarea>
    <div class="tiny">Déjalo vacío si no lo usas.</div>
  </div>
</details>

      <div class="btns">
  <button id="btnGenerate">Generar</button>
  <button id="btnCopy">Copiar</button>
</div>

<details style="margin-top:10px">
  <summary class="tiny" style="cursor:pointer">Más opciones</summary>
  <div class="btns" style="margin-top:10px">
    <button id="btnVerify">Verificar</button>
    <button id="btnReset">Limpiar</button>
  </div>
</details>

      <div id="msg" class="msg tiny"></div>
    </div>

    <div class="card">
      <label>Token (para copiar/pegar)</label>
      <textarea id="token" placeholder="Aquí aparecerá el token..." readonly></textarea>

      <label>Payload decodificado (solo lectura)</label>
      <textarea id="payloadOut" readonly></textarea>
    </div>

    
  </main>

<script>
  // ================== CONFIG (SECRET embebido) ==================
  // Cambia este valor antes de usar en producción.
  const SECRET = "Sk1nn3r%%2025";

  // ===== Utils =====
  const $ = (id) => document.getElementById(id);

  function b64uEncode(bytes) {
    let bin = "";
    const arr = new Uint8Array(bytes);
    for (let i=0; i<arr.length; i++) bin += String.fromCharCode(arr[i]);
    return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }

  function b64uToBytes(b64u) {
    const b64 = b64u.replace(/-/g, "+").replace(/_/g, "/") + "===".slice((b64u.length + 3) % 4);
    const str = atob(b64);
    const bytes = new Uint8Array(str.length);
    for (let i=0; i<str.length; i++) bytes[i] = str.charCodeAt(i);
    return bytes;
  }

  function textToBytes(s) { return new TextEncoder().encode(s); }
  function bytesToText(b) { return new TextDecoder().decode(b); }

  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function addDaysISO(days) {
    const d = new Date();
    d.setDate(d.getDate() + Number(days||0));
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function planToDays(plan){
    if (plan === "demo") return 30;
    if (plan === "pro") return 180;
    if (plan === "premium") return 365;
    return 30;
  }

  function randId() {
    const a = crypto.getRandomValues(new Uint8Array(6));
    return "PCL-" + b64uEncode(a);
  }

  async function hmacSha256(secret, message) {
    const key = await crypto.subtle.importKey(
      "raw",
      textToBytes(secret),
      { name: "HMAC", hash: "SHA-256" },
      false,
      ["sign"]
    );
    const sig = await crypto.subtle.sign("HMAC", key, textToBytes(message));
    return b64uEncode(sig);
  }

  function setMsg(text, ok=true) {
    $("msg").innerHTML = ok
      ? `<span class="ok">✅ ${text}</span>`
      : `<span class="bad">❌ ${text}</span>`;
  }

  function parseFeatures() {
    const raw = ($("features").value || "").trim();
    if (!raw) return {};
    const obj = JSON.parse(raw);
    if (typeof obj !== "object" || obj === null) throw new Error("features debe ser un objeto JSON");
    return obj;
  }

  // ===== Generate =====
  $("btnGenerate").addEventListener("click", async () => {
    try{
      const user = ($("user").value || "").trim();
      const plan = ($("plan").value || "demo").trim();
      const lic_id = randId();
      const features = parseFeatures();
      const exp = addDaysISO(planToDays(plan));

      if (!SECRET) return setMsg("SECRET no configurado en este archivo.", false);
      if (!user) return setMsg("Falta el nombre del titular.", false);

      const payload = {
        lic_id,
        user,
        plan,
        exp,
        features,
        issued_at: todayISO()
      };

      const payloadJson = JSON.stringify(payload);
      const payloadB64u = b64uEncode(textToBytes(payloadJson));

      // TOKEN (2 partes): payload.signature
      const sigB64u = await hmacSha256(SECRET, payloadB64u);
      const token = `${payloadB64u}.${sigB64u}`;

      $("token").value = token;
      $("payloadOut").value = JSON.stringify(payload, null, 2);
      setMsg(`Token generado. Vence: ${exp}`);
    }catch(e){
      setMsg(e.message || String(e), false);
    }
  });

  // ===== Copy =====
  $("btnCopy").addEventListener("click", async () => {
    try{
      const token = ($("token").value || "").trim();
      if (!token) return setMsg("No hay token para copiar.", false);

      await navigator.clipboard.writeText(token);
      setMsg("Token copiado.");
    }catch(e){
      const t = $("token");
      t.removeAttribute("readonly");
      t.focus();
      t.select();
      t.setSelectionRange(0, t.value.length);
      t.setAttribute("readonly","readonly");
      setMsg("No pude copiar automático. El token quedó seleccionado: usa 'Copiar' del sistema.", false);
    }
  });

  // ===== Verify local =====
  $("btnVerify").addEventListener("click", async () => {
    try{
      const token = ($("token").value || "").trim();
      if (!SECRET) return setMsg("SECRET no configurado.", false);
      if (!token || !token.includes(".")) return setMsg("Token inválido.", false);

      const parts = token.split(".");
      if (parts.length !== 2) return setMsg("Token inválido: se esperan 2 partes payload.signature", false);

      const payloadB64u = parts[0];
      const sigB64u = parts[1];

      const expected = await hmacSha256(SECRET, payloadB64u);
      if (expected !== sigB64u) return setMsg("Firma NO coincide (token modificado).", false);

      const payload = JSON.parse(bytesToText(b64uToBytes(payloadB64u)));
      $("payloadOut").value = JSON.stringify(payload, null, 2);

      if (!payload.exp) return setMsg("Payload: exp faltante.", false);
      if (payload.exp < todayISO()) return setMsg("Licencia vencida.", false);

      setMsg(`Token válido y vigente. Vence: ${payload.exp}`);
    }catch(e){
      setMsg(e.message || String(e), false);
    }
  });

  // ===== Reset =====
  $("btnReset").addEventListener("click", () => {
    $("user").value = "";
    $("plan").value = "demo";
    $("token").value = "";
    $("payloadOut").value = "";
    $("features").value = '{ "whatsapp": true, "dictamen": true }';
    setMsg("Listo. Formulario limpio.");
  });

  // init
  setMsg("Listo para generar.");
</script>
</body>
</html>
